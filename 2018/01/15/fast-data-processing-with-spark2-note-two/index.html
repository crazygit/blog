<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>《Fast Data Processing with Spark 2（Third Edition)》读书笔记二 - Soul Mate</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="crazygit" /><meta name="description" content="本文主要介绍在Spark中加载和保存数据, 以及Spark的一些概念和Spark SQL查询
" />

  <meta name="keywords" content="Hugo, crazygit, blog" />


<meta name="baidu-site-verification" content="mEI3NT6pyx" />
<meta name="google-site-verification" content="AbF6G10N67H-FaerplTnvfAXJrTtXBGHdr4xsSot7z8" />


<meta name="generator" content="Hugo 0.60.0" />


<link rel="canonical" href="https://crazygit.wiseturtles.com/2018/01/15/fast-data-processing-with-spark2-note-two/" />



<link rel="icon" href="/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">








<link rel="stylesheet" href="/sass/jane.min.af20b78e95c84de86b00a0242a4a77bd2601700e1b250edf27537d957ac0041d.css" integrity="sha256-ryC3jpXITehrAKAkKkp3vSYBcA4bJQ7fJ1N9lXrABB0=" media="screen" crossorigin="anonymous">




<link rel="stylesheet" href="/css/douban.css">

<link rel="stylesheet" href="/css/monokai-syntax.css">


<meta property="og:title" content="《Fast Data Processing with Spark 2（Third Edition)》读书笔记二" />
<meta property="og:description" content="本文主要介绍在Spark中加载和保存数据, 以及Spark的一些概念和Spark SQL查询
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://crazygit.wiseturtles.com/2018/01/15/fast-data-processing-with-spark2-note-two/" />
<meta property="article:published_time" content="2018-01-15T17:45:35+08:00" />
<meta property="article:modified_time" content="2018-01-15T17:45:35+08:00" />
<meta itemprop="name" content="《Fast Data Processing with Spark 2（Third Edition)》读书笔记二">
<meta itemprop="description" content="本文主要介绍在Spark中加载和保存数据, 以及Spark的一些概念和Spark SQL查询
">
<meta itemprop="datePublished" content="2018-01-15T17:45:35&#43;08:00" />
<meta itemprop="dateModified" content="2018-01-15T17:45:35&#43;08:00" />
<meta itemprop="wordCount" content="4308">



<meta itemprop="keywords" content="spark," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="《Fast Data Processing with Spark 2（Third Edition)》读书笔记二"/>
<meta name="twitter:description" content="本文主要介绍在Spark中加载和保存数据, 以及Spark的一些概念和Spark SQL查询
"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-112251188-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Soul Mate</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://crazygit.wiseturtles.com/">主页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://crazygit.wiseturtles.com/categories/">分类</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://crazygit.wiseturtles.com/post/">归档</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://crazygit.wiseturtles.com/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://crazygit.wiseturtles.com/books/">读书</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://crazygit.wiseturtles.com/about/">关于</a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      Soul Mate
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://crazygit.wiseturtles.com/">主页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://crazygit.wiseturtles.com/categories/">分类</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://crazygit.wiseturtles.com/post/">归档</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://crazygit.wiseturtles.com/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://crazygit.wiseturtles.com/books/">读书</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://crazygit.wiseturtles.com/about/">关于</a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">《Fast Data Processing with Spark 2（Third Edition)》读书笔记二</h1>
      
      <div class="post-meta">
        <time datetime="2018-01-15" class="post-time">
          2018-01-15
        </time>
        <div class="post-category">
            <a href="https://crazygit.wiseturtles.com/categories/spark/"> spark </a>
            
          </div>
        <span class="more-meta"> 约 4308 字 </span>
          <span class="more-meta"> 预计阅读 9 分钟 </span>

        
        

        
        
          <span id="/2018/01/15/fast-data-processing-with-spark2-note-two/" class="leancloud_visitors" data-flag-title="《Fast Data Processing with Spark 2（Third Edition)》读书笔记二">
            <span class="post-meta-item-text"> | 阅读 </span>
            <span class="leancloud-visitors-count"></span>
          </span>
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#spark">在Spark中加载和保存数据</a>
      <ul>
        <li><a href="#spark1">Spark抽象概念</a></li>
        <li><a href="#rdds">RDDs</a></li>
        <li><a href="#heading">数据形态</a></li>
        <li><a href="#datasetsdataframesrdds">数据形态和Datasets/DataFrames/RDDs</a></li>
        <li><a href="#rdd">加载数据到RDD</a></li>
        <li><a href="#rdd1">保存RDD数据</a></li>
      </ul>
    </li>
    <li><a href="#spark20-">Spark2.0 概念</a>
      <ul>
        <li><a href="#data-hub">Data Hub</a></li>
        <li><a href="#reporting-hub">Reporting Hub</a></li>
        <li><a href="#analytics-hub">Analytics Hub</a></li>
        <li><a href="#spark-full-stack">Spark Full Stack</a></li>
        <li><a href="#parquethttpsparquetapacheorg">大数据存储Parquet</a></li>
      </ul>
    </li>
    <li><a href="#spark-sql">Spark SQL</a>
      <ul>
        <li><a href="#heading1">单表查询</a></li>
        <li><a href="#heading2">多表查询</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <p>本书其它笔记<a href="https://crazygit.wiseturtles.com/2018/01/26/fast-data-processing-with-spark2-note-index/">Fast Data Processing with Spark 2（Third Edition)》读书笔记目</a></p>
<h2 id="spark">在Spark中加载和保存数据</h2>
<p>在我们开始操作数据之前，让我们先看一些Spark的概念以及了解一下不同的数据形态</p>
<h3 id="spark1">Spark抽象概念</h3>
<p>Saprk的主要特点就是分布式的数据描述(representation)和计算，因此拥有大规模的数据操作。<em>Spark主要的数据描述单元就是<code>RDD</code></em>(原句是: Spark's primary unit for representation of data is RDD)， 可以很方便的允许并行的数据计算。在Saprk 2.0.0版本之前，都是基于<code>RDDs</code>工作的。然而，它们都是低级别的原始结构，在执行和扩展上有很大的优化空间。因此才有了<code>Datasets/DataFrames</code>。<code>Datasets/DataFrames</code>是API级别的抽象，也是编程的主要接口，它提供了大量操作<code>RDD</code>, 但是通过优化查询计划在<code>RDDs</code>上封装了一层。因此，底层仍然是<code>RDD</code>, 只是通过<code>Datasets/DataFrames</code>的API来访问。</p>
<blockquote>
<p>RDDs can be viewed as arrays of arrays with primitive data types, such as integers, floats, and strings.</p>
<p>Datasets/DataFrames, on the other hand, are similar to a table or a spreadsheet with column headings-such as name, title, order number, order date, and movie rating-and the associated data types.</p>
</blockquote>
<p><code>RDDs</code>可以看做是一系列原始数据数组的集合，比如: 整型，浮点型和字符串。<code>Datasets/DataFrames</code>在另一方面来说，有点类似一张表单或表格，有许多列标题（比如姓名，标题，订单号，订单日期，电影评分）以及关联的数据类型。</p>
<p>无论在什么情况下。当使用<code>Datasets/DataFrames</code>,通过用<code>SparkSession</code>操作。然而，当需要进行一些低级别的操作来实复杂的计算或累加时，就是用<code>RDDs</code>,通过<code>SparkContext</code>来操作。</p>
<p>使用<code>dataset.rdd()</code>和<code>SparkSession.createDataset(rdd)/SparkSession.createDataFr ame(rdd)</code>方法，可以将<code>RDDs</code>转变为<code>Datasets/DataFrames</code>。</p>
<h3 id="rdds">RDDs</h3>
<p>我们可以使用任何Hadoop支持的数据源来创建<code>RDDs</code>。Scala, Java, Python语言的原始数据结构都可以作为<code>RDD</code>的基础。使用原始的数据集合创建<code>RDDs</code>在测试时非常有用。</p>
<p>由于<code>RDD</code>是懒加载，它只有在它被需要时才会去计算。也就是说：当你尝试从<code>RDD</code>获取数据时，可能会失败。<code>RDD</code>里的数据只有在被缓存引用或输出时才会通过计算创建，这也意味着你可以构造大量的计算而不用担心阻塞计算线程。甚至，只有当你在具体化<code>RDD</code>（materialize the RDD）时，代码才会去加载原始数据。</p>
<p><strong>Tips</strong>:</p>
<p>每次你具体化<code>RDD</code>时，它都会计算一次。因此，当频繁的使用时，可以借助缓存机制来提高效率。</p>
<h3 id="heading">数据形态</h3>
<p>从数据形态的角度来说，所有的数据可以分成三类</p>
<ul>
<li>
<p><strong>结构化的数据（Structured data</strong>），通常存储在数据库里，如Oracle, HBase, Cassandra等，关系型数据库是最常见的结构化数据的存储方式。结构化的数据样式，数据类型和数据大小都是已知的。</p>
</li>
<li>
<p><strong>半结构化的数据（Semi-structured data）</strong>，
正如它的名字一样，它也是有结构的数据，只是数据样式，数据类型和数据大小是可变。常见的半结构化数据格式有:<code>csv</code>, <code>json</code>和<code>parquet</code></p>
</li>
<li>
<p><strong>无结构的数据（Unstructured data）</strong>，目前我们遇到的85%的数据都是这种格式。如图形，音频文件，社交文化等。大部分的数据处理，都是从无结构的数据开始，通过ETL(Extract-Transform-Load)，变型和其它技术，最终变成结构化的数据。</p>
</li>
</ul>
<h3 id="datasetsdataframesrdds">数据形态和<code>Datasets/DataFrames/RDDs</code></h3>
<p>现在让我们结合数据形态以及spark的抽象概念来看看如何使用spark读写数据。</p>
<p>在Spark 2.0.0之前，我们只需要使用<code>RDDs</code>和<code>map()</code>函数来按照需要改变数据。但是，当使用<code>Dataset/DataFrame</code>, 变得稍微复杂一些， 我们可以直接读入类似一张表的数据，包含数据类型和列信息，也可以更高效的工作。</p>
<p>通常来说:</p>
<ol>
<li>
<p>使用<code>SparkContext</code>和<code>RDDs</code>来处非无结构的数据</p>
</li>
<li>
<p>使用<code>SparkSession</code>和<code> Datasets/DataFrames</code>来处理结构化和半结构化的数据。<code>SparkSession</code>有统一的标准处理各种格式的数据，如: <code>.csv</code>, <code>.json</code>, <code>.parquet</code>, <code>.jdbc</code>, <code>.orc</code>。还有一个可插拔的结构叫做<code>DataSource API</code>, 可以处理任意类型的结构化数据</p>
</li>
</ol>
<h3 id="rdd">加载数据到RDD</h3>
<p>创建RDD最简单的方式就是使用编程语言(Scala, Python, Java)原始的数据结构，
<code>SparkContext</code>对象有个方法<code>parallelize</code>可以实现这个功能。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="o">&gt;&gt;</span><span class="o">&gt;</span> <span class="n">rdd</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">parallelize</span><span class="p">(</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="p">)</span>

<span class="o">&gt;&gt;</span><span class="o">&gt;</span> <span class="n">rdd</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
</code></pre></td></tr></table>
</div>
</div><p>加载外部数据最简单的方式就是读取一个文本文件。如果是单机模式的话，这个很简单，主要确保文件在本机即可。但是在集群环境下时需要注意，文件需要存在集群上的每个节点上，在分布式环境下，我们可以使用<code>addFile</code>方法，让Spark把文件拷贝到集群的每个机器上，如:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="o">&gt;&gt;</span><span class="o">&gt;</span> <span class="kn">from</span> <span class="nn">pyspark.files</span> <span class="kn">import</span> <span class="n">SparkFiles</span>

<span class="o">&gt;&gt;</span><span class="o">&gt;</span> <span class="n">sc</span><span class="o">.</span><span class="n">addd</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">data/spam.data</span><span class="s2">&#34;</span><span class="p">)</span>

<span class="o">&gt;&gt;</span><span class="o">&gt;</span> <span class="n">sc</span><span class="o">.</span><span class="n">addFile</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">data/spam.data</span><span class="s2">&#34;</span><span class="p">)</span>

<span class="o">&gt;&gt;</span><span class="o">&gt;</span> <span class="n">in_file</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">textFile</span><span class="p">(</span><span class="n">SparkFiles</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">spam.data</span><span class="s2">&#34;</span><span class="p">)</span><span class="p">)</span>

<span class="o">&gt;&gt;</span><span class="o">&gt;</span> <span class="n">in_file</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">[</span><span class="sa">u</span><span class="s1">&#39;</span><span class="s1">0 0.64 0.64 0 0.32 0 0 0 0 0 0 0.64 0 0 0 0.32 0 1.29 1.93 0 0.96 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.778 0 0 3.756 61 278 1</span><span class="s1">&#39;</span><span class="p">]</span>
</code></pre></td></tr></table>
</div>
</div><p>通常，我们输入的文件都是CSV或TSV文件。一般在创建RDDs时，都需要先解析数据。
通常有两种做法:</p>
<ol>
<li>自己写函数读取和解析CSV文件</li>
<li>使用第三库，比如<code>opencsv</code></li>
</ol>
<p>我们看看自己写函数的方式</p>
<pre><code>&gt;&gt;&gt; !cat data/Line_of_numbers.csv
42,42,55,61,53,49,43,47,49,60,68,54,34,35,35,39
&gt;&gt;&gt; inp_file = sc.textFile(&quot;data/Line_of_numbers.csv&quot;)

&gt;&gt;&gt; numbers_rdd = inp_file.map(lambda line: line.split(','))

&gt;&gt;&gt; numbers_rdd.take(10)
[[u'42',
  u'42',
  u'55',
  u'61',
  u'53',
  u'49',
  u'43',
  u'47',
  u'49',
  u'60',
  u'68',
  u'54',
  u'34',
  u'35',
  u'35',
  u'39']]
</code></pre><p>得到的数据都是字符串类型，我们希望把它转换为整型或浮点型</p>
<pre><code>&gt;&gt;&gt; numbers_rdd = inp_file.flatMap(lambda line:
...            line.split(',')).map(lambda x:float(x))
...

&gt;&gt;&gt; numbers_rdd.take(10)
[42.0, 42.0, 55.0, 61.0, 53.0, 49.0, 43.0, 47.0, 49.0, 60.0]

&gt;&gt;&gt; numbers_sum = numbers_rdd.sum()

&gt;&gt;&gt; numbers_sum
766.0
</code></pre><p>注意上面解析文件时先使用的是<code>flatMap</code>，再使用的<code>map</code>。<code>flatMap</code>会将结果变成数组</p>
<pre><code>&gt;&gt;&gt; inp_file.map(lambda line: line.split(',')).take(10)
[[u'42',
  u'42',
  u'55',
  u'61',
  u'53',
  u'49',
  u'43',
  u'47',
  u'49',
  u'60',
  u'68',
  u'54',
  u'34',
  u'35',
  u'35',
  u'39']]

&gt;&gt;&gt; inp_file.flatMap(lambda line: line.split(',')).take(10)
[u'42', u'42', u'55', u'61', u'53', u'49', u'43', u'47', u'49', u'60']
</code></pre><p>从Spark获取数据还可以使用<code>collect()</code>方法，用它可以获得原始的数据形式，跟<code>parallelize()</code>作用相反，<code>parallelize()</code>解析数据把它转换成RDD，<code>collect()</code>获取执行结果。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="o">&gt;&gt;</span><span class="o">&gt;</span> <span class="n">inp_file</span><span class="o">.</span><span class="n">flatMap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">line</span><span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">,</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="p">)</span>
<span class="p">[</span><span class="sa">u</span><span class="s1">&#39;</span><span class="s1">42</span><span class="s1">&#39;</span><span class="p">,</span>
 <span class="sa">u</span><span class="s1">&#39;</span><span class="s1">42</span><span class="s1">&#39;</span><span class="p">,</span>
 <span class="sa">u</span><span class="s1">&#39;</span><span class="s1">55</span><span class="s1">&#39;</span><span class="p">,</span>
 <span class="sa">u</span><span class="s1">&#39;</span><span class="s1">61</span><span class="s1">&#39;</span><span class="p">,</span>
 <span class="sa">u</span><span class="s1">&#39;</span><span class="s1">53</span><span class="s1">&#39;</span><span class="p">,</span>
 <span class="sa">u</span><span class="s1">&#39;</span><span class="s1">49</span><span class="s1">&#39;</span><span class="p">,</span>
 <span class="sa">u</span><span class="s1">&#39;</span><span class="s1">43</span><span class="s1">&#39;</span><span class="p">,</span>
 <span class="sa">u</span><span class="s1">&#39;</span><span class="s1">47</span><span class="s1">&#39;</span><span class="p">,</span>
 <span class="sa">u</span><span class="s1">&#39;</span><span class="s1">49</span><span class="s1">&#39;</span><span class="p">,</span>
 <span class="sa">u</span><span class="s1">&#39;</span><span class="s1">60</span><span class="s1">&#39;</span><span class="p">,</span>
 <span class="sa">u</span><span class="s1">&#39;</span><span class="s1">68</span><span class="s1">&#39;</span><span class="p">,</span>
 <span class="sa">u</span><span class="s1">&#39;</span><span class="s1">54</span><span class="s1">&#39;</span><span class="p">,</span>
 <span class="sa">u</span><span class="s1">&#39;</span><span class="s1">34</span><span class="s1">&#39;</span><span class="p">,</span>
 <span class="sa">u</span><span class="s1">&#39;</span><span class="s1">35</span><span class="s1">&#39;</span><span class="p">,</span>
 <span class="sa">u</span><span class="s1">&#39;</span><span class="s1">35</span><span class="s1">&#39;</span><span class="p">,</span>
 <span class="sa">u</span><span class="s1">&#39;</span><span class="s1">39</span><span class="s1">&#39;</span><span class="p">]</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="rdd1">保存RDD数据</h3>
<p>使用<code>saveAsTextFile</code>方法可以保存RDD数据</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="o">&gt;&gt;</span><span class="o">&gt;</span> <span class="err">!</span><span class="n">cat</span> <span class="n">data</span><span class="o">/</span><span class="n">Line_of_numbers</span><span class="o">.</span><span class="n">csv</span>
<span class="mi">42</span><span class="p">,</span><span class="mi">42</span><span class="p">,</span><span class="mi">55</span><span class="p">,</span><span class="mi">61</span><span class="p">,</span><span class="mi">53</span><span class="p">,</span><span class="mi">49</span><span class="p">,</span><span class="mi">43</span><span class="p">,</span><span class="mi">47</span><span class="p">,</span><span class="mi">49</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">68</span><span class="p">,</span><span class="mi">54</span><span class="p">,</span><span class="mi">34</span><span class="p">,</span><span class="mi">35</span><span class="p">,</span><span class="mi">35</span><span class="p">,</span><span class="mi">39</span>

<span class="o">&gt;&gt;</span><span class="o">&gt;</span> <span class="n">inp_file</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">textFile</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">data/Line_of_numbers.csv</span><span class="s2">&#34;</span><span class="p">)</span>

<span class="o">&gt;&gt;</span><span class="o">&gt;</span> <span class="n">inp_file</span><span class="o">.</span><span class="n">saveAsTextFile</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">out.txt</span><span class="s2">&#34;</span><span class="p">)</span>

<span class="o">&gt;&gt;</span><span class="o">&gt;</span> <span class="err">!</span><span class="nb">file</span> <span class="n">out</span><span class="o">.</span><span class="n">txt</span><span class="o">/</span><span class="o">*</span>
<span class="n">out</span><span class="o">.</span><span class="n">txt</span><span class="o">/</span><span class="n">_SUCCESS</span><span class="p">:</span>   <span class="n">empty</span>
<span class="n">out</span><span class="o">.</span><span class="n">txt</span><span class="o">/</span><span class="n">part</span><span class="o">-</span><span class="mo">00000</span><span class="p">:</span> <span class="n">ASCII</span> <span class="n">text</span>
<span class="n">out</span><span class="o">.</span><span class="n">txt</span><span class="o">/</span><span class="n">part</span><span class="o">-</span><span class="mo">00001</span><span class="p">:</span> <span class="n">empty</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看到是以目录的形式保存的数据</p>
<p>读取保存的数据</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="o">&gt;&gt;</span><span class="o">&gt;</span> <span class="n">read_file</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">textFile</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">out.txt</span><span class="s2">&#34;</span><span class="p">)</span>

<span class="o">&gt;&gt;</span><span class="o">&gt;</span> <span class="n">read_file</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="p">[</span><span class="sa">u</span><span class="s1">&#39;</span><span class="s1">42,42,55,61,53,49,43,47,49,60,68,54,34,35,35,39</span><span class="s1">&#39;</span><span class="p">]</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="spark20-">Spark2.0 概念</h2>
<p>下图是一个数据掮客的架构:</p>
<p><img src="http://images.wiseturtles.com/2018-01-14-StackArchitecture.png" alt="Stack Architecture"></p>
<ul>
<li>Data Hub</li>
<li>Analytics Hub</li>
<li>Reporting Hub</li>
<li>Visualization</li>
<li>ETL</li>
</ul>
<h3 id="data-hub">Data Hub</h3>
<p>数据中心 存储所有数据，数据来自于ETL服务，Kafaka等。数据可以是多种主题: 如市场数据，交易数据，文本日志，社交数据，非结构化的数据。也可以是一些跟时间序列相关的数据。</p>
<h3 id="reporting-hub">Reporting Hub</h3>
<p>报告中心 通常包含结构化和聚合之后的数据，用于日常报表和可视化面板。spark在这里主要做ETL和变形。数据可视化工具,比如:</p>
<ul>
<li>Tableau</li>
<li>Quilk</li>
<li>Pentaho</li>
</ul>
<p>可以直接通过SparkSQL读取Spark里的数据。</p>
<h3 id="analytics-hub">Analytics Hub</h3>
<p>分析中心 是数据分析师花费大部分时间的地方。分析中心可以从数据中心获取大量数据，
然后生成intermediate Datasets，特征提取，model Datasets。</p>
<p>DataFrames, MLlib, GraphX, and ML pipelines 也在这里生成。</p>
<h3 id="spark-full-stack">Spark Full Stack</h3>
<p><img src="http://images.wiseturtles.com/2018-01-15-SparkFullStack.png" alt="Spark Full Stack"></p>
<h3 id="parquethttpsparquetapacheorg"><a href="https://parquet.apache.org/">大数据存储Parquet</a></h3>
<h2 id="spark-sql">Spark SQL</h2>
<p><img src="http://images.wiseturtles.com/2018-01-15-SparkSQLArchitecture.png" alt="Spark SQL Architeture"></p>
<p>下面的例子使用的数据文件下载地址:</p>
<p><a href="https://github.com/xsankar/fdps-v3">https://github.com/xsankar/fdps-v3</a></p>
<h3 id="heading1">单表查询</h3>
<p>读取csv文件, 返回的<code>employees</code>是一个<code>pyspark.sql.dataframe.DataFrame</code>类型</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="o">&gt;&gt;</span><span class="o">&gt;</span> <span class="k">print</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">Running Spark version: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">spark</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
<span class="n">Running</span> <span class="n">Spark</span> <span class="n">version</span><span class="p">:</span> <span class="mf">2.2</span><span class="o">.</span><span class="mi">1</span>

<span class="o">&gt;&gt;</span><span class="o">&gt;</span> <span class="n">employees</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">header</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">true</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">data/NW-Employees.csv</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>统计总行数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="o">&gt;&gt;</span><span class="o">&gt;</span> <span class="k">print</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">Employees has </span><span class="si">%d</span><span class="s1"> rows</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">employees</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="p">)</span><span class="p">)</span>
<span class="n">Employees</span> <span class="n">has</span> <span class="mi">9</span> <span class="n">rows</span>
</code></pre></td></tr></table>
</div>
</div><p>打印前5行</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="o">&gt;&gt;</span><span class="o">&gt;</span> <span class="n">employees</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span>
<span class="o">|</span><span class="n">EmployeeID</span><span class="o">|</span> <span class="n">LastName</span><span class="o">|</span><span class="n">FirstName</span><span class="o">|</span>               <span class="n">Title</span><span class="o">|</span><span class="n">BirthDate</span><span class="o">|</span><span class="n">HireDate</span><span class="o">|</span>    <span class="n">City</span><span class="o">|</span><span class="n">State</span><span class="o">|</span>    <span class="n">Zip</span><span class="o">|</span><span class="n">Country</span><span class="o">|</span><span class="n">ReportsTo</span><span class="o">|</span>
<span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span>
<span class="o">|</span>         <span class="mi">1</span><span class="o">|</span>   <span class="n">Fuller</span><span class="o">|</span>   <span class="n">Andrew</span><span class="o">|</span><span class="n">Sales</span> <span class="n">Representative</span><span class="o">|</span>  <span class="mi">12</span><span class="o">/</span><span class="mi">6</span><span class="o">/</span><span class="mi">48</span><span class="o">|</span> <span class="mi">4</span><span class="o">/</span><span class="mi">29</span><span class="o">/</span><span class="mi">92</span><span class="o">|</span> <span class="n">Seattle</span><span class="o">|</span>   <span class="n">WA</span><span class="o">|</span>  <span class="mi">98122</span><span class="o">|</span>    <span class="n">USA</span><span class="o">|</span>        <span class="mi">2</span><span class="o">|</span>
<span class="o">|</span>         <span class="mi">2</span><span class="o">|</span>  <span class="n">Davolio</span><span class="o">|</span>    <span class="n">Nancy</span><span class="o">|</span><span class="n">Vice</span> <span class="n">President</span><span class="p">,</span> <span class="n">S</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">|</span>  <span class="mi">2</span><span class="o">/</span><span class="mi">17</span><span class="o">/</span><span class="mi">52</span><span class="o">|</span> <span class="mi">8</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">92</span><span class="o">|</span>  <span class="n">Tacoma</span><span class="o">|</span>   <span class="n">WA</span><span class="o">|</span>  <span class="mi">98401</span><span class="o">|</span>    <span class="n">USA</span><span class="o">|</span>        <span class="mi">0</span><span class="o">|</span>
<span class="o">|</span>         <span class="mi">3</span><span class="o">|</span><span class="n">Leverling</span><span class="o">|</span>    <span class="n">Janet</span><span class="o">|</span><span class="n">Sales</span> <span class="n">Representative</span><span class="o">|</span>  <span class="mi">8</span><span class="o">/</span><span class="mi">28</span><span class="o">/</span><span class="mi">63</span><span class="o">|</span> <span class="mi">3</span><span class="o">/</span><span class="mi">30</span><span class="o">/</span><span class="mi">92</span><span class="o">|</span><span class="n">Kirkland</span><span class="o">|</span>   <span class="n">WA</span><span class="o">|</span>  <span class="mi">98033</span><span class="o">|</span>    <span class="n">USA</span><span class="o">|</span>        <span class="mi">2</span><span class="o">|</span>
<span class="o">|</span>         <span class="mi">4</span><span class="o">|</span>  <span class="n">Peacock</span><span class="o">|</span> <span class="n">Margaret</span><span class="o">|</span><span class="n">Sales</span> <span class="n">Representative</span><span class="o">|</span>  <span class="mi">9</span><span class="o">/</span><span class="mi">17</span><span class="o">/</span><span class="mi">37</span><span class="o">|</span>  <span class="mi">5</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="mi">93</span><span class="o">|</span> <span class="n">Redmond</span><span class="o">|</span>   <span class="n">WA</span><span class="o">|</span>  <span class="mi">98052</span><span class="o">|</span>    <span class="n">USA</span><span class="o">|</span>        <span class="mi">2</span><span class="o">|</span>
<span class="o">|</span>         <span class="mi">5</span><span class="o">|</span><span class="n">Dodsworth</span><span class="o">|</span>     <span class="n">Anne</span><span class="o">|</span>       <span class="n">Sales</span> <span class="n">Manager</span><span class="o">|</span>   <span class="mi">3</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="mi">55</span><span class="o">|</span><span class="mi">10</span><span class="o">/</span><span class="mi">15</span><span class="o">/</span><span class="mi">93</span><span class="o">|</span>  <span class="n">London</span><span class="o">|</span> <span class="n">null</span><span class="o">|</span><span class="n">SW1</span> <span class="mi">8</span><span class="n">JR</span><span class="o">|</span>     <span class="n">UK</span><span class="o">|</span>        <span class="mi">2</span><span class="o">|</span>
<span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">5</span> <span class="n">rows</span>
</code></pre></td></tr></table>
</div>
</div><p>返回前3行</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="o">&gt;&gt;</span><span class="o">&gt;</span> <span class="n">employees</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="p">[</span><span class="n">Row</span><span class="p">(</span><span class="n">EmployeeID</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">1</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">LastName</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">Fuller</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">FirstName</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">Andrew</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">Title</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">Sales Representative</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">BirthDate</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">12/6/48</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">HireDate</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">4/29/92</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">City</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">Seattle</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">State</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">WA</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">Zip</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">98122</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">Country</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">USA</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ReportsTo</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">2</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">,</span>
 <span class="n">Row</span><span class="p">(</span><span class="n">EmployeeID</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">2</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">LastName</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">Davolio</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">FirstName</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">Nancy</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">Title</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">Vice President, Sales</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">BirthDate</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">2/17/52</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">HireDate</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">8/12/92</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">City</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">Tacoma</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">State</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">WA</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">Zip</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">98401</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">Country</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">USA</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ReportsTo</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">0</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">,</span>
 <span class="n">Row</span><span class="p">(</span><span class="n">EmployeeID</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">3</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">LastName</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">Leverling</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">FirstName</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">Janet</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">Title</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">Sales Representative</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">BirthDate</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">8/28/63</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">HireDate</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">3/30/92</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">City</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">Kirkland</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">State</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">WA</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">Zip</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">98033</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">Country</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">USA</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ReportsTo</span><span class="o">=</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">2</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">]</span>
</code></pre></td></tr></table>
</div>
</div><p>查看每一列的数据类型</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="o">&gt;&gt;</span><span class="o">&gt;</span> <span class="k">for</span> <span class="n">column_name</span><span class="p">,</span> <span class="n">data_type</span> <span class="ow">in</span> <span class="n">employees</span><span class="o">.</span><span class="n">dtypes</span><span class="p">:</span>
<span class="o">.</span><span class="o">.</span><span class="o">.</span>     <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">{column_name}: {data_type}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="o">.</span><span class="o">.</span><span class="o">.</span>
<span class="n">EmployeeID</span><span class="p">:</span> <span class="n">string</span>
<span class="n">LastName</span><span class="p">:</span> <span class="n">string</span>
<span class="n">FirstName</span><span class="p">:</span> <span class="n">string</span>
<span class="n">Title</span><span class="p">:</span> <span class="n">string</span>
<span class="n">BirthDate</span><span class="p">:</span> <span class="n">string</span>
<span class="n">HireDate</span><span class="p">:</span> <span class="n">string</span>
<span class="n">City</span><span class="p">:</span> <span class="n">string</span>
<span class="n">State</span><span class="p">:</span> <span class="n">string</span>
<span class="n">Zip</span><span class="p">:</span> <span class="n">string</span>
<span class="n">Country</span><span class="p">:</span> <span class="n">string</span>
<span class="n">ReportsTo</span><span class="p">:</span> <span class="n">string</span>
</code></pre></td></tr></table>
</div>
</div><p>查看schema</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="o">&gt;&gt;</span><span class="o">&gt;</span> <span class="n">employees</span><span class="o">.</span><span class="n">printSchema</span><span class="p">(</span><span class="p">)</span>
<span class="n">root</span>
 <span class="o">|</span><span class="o">-</span><span class="o">-</span> <span class="n">EmployeeID</span><span class="p">:</span> <span class="n">string</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
 <span class="o">|</span><span class="o">-</span><span class="o">-</span> <span class="n">LastName</span><span class="p">:</span> <span class="n">string</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
 <span class="o">|</span><span class="o">-</span><span class="o">-</span> <span class="n">FirstName</span><span class="p">:</span> <span class="n">string</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
 <span class="o">|</span><span class="o">-</span><span class="o">-</span> <span class="n">Title</span><span class="p">:</span> <span class="n">string</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
 <span class="o">|</span><span class="o">-</span><span class="o">-</span> <span class="n">BirthDate</span><span class="p">:</span> <span class="n">string</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
 <span class="o">|</span><span class="o">-</span><span class="o">-</span> <span class="n">HireDate</span><span class="p">:</span> <span class="n">string</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
 <span class="o">|</span><span class="o">-</span><span class="o">-</span> <span class="n">City</span><span class="p">:</span> <span class="n">string</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
 <span class="o">|</span><span class="o">-</span><span class="o">-</span> <span class="n">State</span><span class="p">:</span> <span class="n">string</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
 <span class="o">|</span><span class="o">-</span><span class="o">-</span> <span class="n">Zip</span><span class="p">:</span> <span class="n">string</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
 <span class="o">|</span><span class="o">-</span><span class="o">-</span> <span class="n">Country</span><span class="p">:</span> <span class="n">string</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
 <span class="o">|</span><span class="o">-</span><span class="o">-</span> <span class="n">ReportsTo</span><span class="p">:</span> <span class="n">string</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>默认读取的数据类型都是<code>String</code>,可以设置<code>inferSchema</code>为<code>true</code>来根据数据自动推测类型。(如下: <code>EmployeeID</code>和<code>EmployeeID</code>自动推测为int)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="o">&gt;&gt;</span><span class="o">&gt;</span> <span class="n">employees</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">header</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">true</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">inferSchema</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">true</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">data/NW-Employees.csv</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="o">&gt;&gt;</span><span class="o">&gt;</span> <span class="k">for</span> <span class="n">column_name</span><span class="p">,</span> <span class="n">data_type</span> <span class="ow">in</span> <span class="n">employees</span><span class="o">.</span><span class="n">dtypes</span><span class="p">:</span>
<span class="o">.</span><span class="o">.</span><span class="o">.</span>     <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">{column_name}: {data_type}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="o">.</span><span class="o">.</span><span class="o">.</span>
<span class="n">EmployeeID</span><span class="p">:</span> <span class="nb">int</span>
<span class="n">LastName</span><span class="p">:</span> <span class="n">string</span>
<span class="n">FirstName</span><span class="p">:</span> <span class="n">string</span>
<span class="n">Title</span><span class="p">:</span> <span class="n">string</span>
<span class="n">BirthDate</span><span class="p">:</span> <span class="n">string</span>
<span class="n">HireDate</span><span class="p">:</span> <span class="n">string</span>
<span class="n">City</span><span class="p">:</span> <span class="n">string</span>
<span class="n">State</span><span class="p">:</span> <span class="n">string</span>
<span class="n">Zip</span><span class="p">:</span> <span class="n">string</span>
<span class="n">Country</span><span class="p">:</span> <span class="n">string</span>
<span class="n">ReportsTo</span><span class="p">:</span> <span class="nb">int</span>

<span class="o">&gt;&gt;</span><span class="o">&gt;</span> <span class="n">employees</span><span class="o">.</span><span class="n">printSchema</span><span class="p">(</span><span class="p">)</span>
<span class="n">root</span>
 <span class="o">|</span><span class="o">-</span><span class="o">-</span> <span class="n">EmployeeID</span><span class="p">:</span> <span class="n">integer</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
 <span class="o">|</span><span class="o">-</span><span class="o">-</span> <span class="n">LastName</span><span class="p">:</span> <span class="n">string</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
 <span class="o">|</span><span class="o">-</span><span class="o">-</span> <span class="n">FirstName</span><span class="p">:</span> <span class="n">string</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
 <span class="o">|</span><span class="o">-</span><span class="o">-</span> <span class="n">Title</span><span class="p">:</span> <span class="n">string</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
 <span class="o">|</span><span class="o">-</span><span class="o">-</span> <span class="n">BirthDate</span><span class="p">:</span> <span class="n">string</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
 <span class="o">|</span><span class="o">-</span><span class="o">-</span> <span class="n">HireDate</span><span class="p">:</span> <span class="n">string</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
 <span class="o">|</span><span class="o">-</span><span class="o">-</span> <span class="n">City</span><span class="p">:</span> <span class="n">string</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
 <span class="o">|</span><span class="o">-</span><span class="o">-</span> <span class="n">State</span><span class="p">:</span> <span class="n">string</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
 <span class="o">|</span><span class="o">-</span><span class="o">-</span> <span class="n">Zip</span><span class="p">:</span> <span class="n">string</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
 <span class="o">|</span><span class="o">-</span><span class="o">-</span> <span class="n">Country</span><span class="p">:</span> <span class="n">string</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
 <span class="o">|</span><span class="o">-</span><span class="o">-</span> <span class="n">ReportsTo</span><span class="p">:</span> <span class="n">integer</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>创建全局临时视图</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="o">&gt;&gt;</span><span class="o">&gt;</span> <span class="n">employees</span><span class="o">.</span><span class="n">createOrReplaceGlobalTempView</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">EmployeesTable</span><span class="s2">&#34;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>查询视图(表名前面的<code>global_temp</code>不能省略，否则会报<code>Table or view not found</code>)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="o">&gt;&gt;</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">select * from global_temp.EmployeesTable</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="o">&gt;&gt;</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span>
<span class="o">|</span><span class="n">EmployeeID</span><span class="o">|</span> <span class="n">LastName</span><span class="o">|</span><span class="n">FirstName</span><span class="o">|</span>               <span class="n">Title</span><span class="o">|</span><span class="n">BirthDate</span><span class="o">|</span><span class="n">HireDate</span><span class="o">|</span>    <span class="n">City</span><span class="o">|</span><span class="n">State</span><span class="o">|</span>    <span class="n">Zip</span><span class="o">|</span><span class="n">Country</span><span class="o">|</span><span class="n">ReportsTo</span><span class="o">|</span>
<span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span>
<span class="o">|</span>         <span class="mi">1</span><span class="o">|</span>   <span class="n">Fuller</span><span class="o">|</span>   <span class="n">Andrew</span><span class="o">|</span><span class="n">Sales</span> <span class="n">Representative</span><span class="o">|</span>  <span class="mi">12</span><span class="o">/</span><span class="mi">6</span><span class="o">/</span><span class="mi">48</span><span class="o">|</span> <span class="mi">4</span><span class="o">/</span><span class="mi">29</span><span class="o">/</span><span class="mi">92</span><span class="o">|</span> <span class="n">Seattle</span><span class="o">|</span>   <span class="n">WA</span><span class="o">|</span>  <span class="mi">98122</span><span class="o">|</span>    <span class="n">USA</span><span class="o">|</span>        <span class="mi">2</span><span class="o">|</span>
<span class="o">|</span>         <span class="mi">2</span><span class="o">|</span>  <span class="n">Davolio</span><span class="o">|</span>    <span class="n">Nancy</span><span class="o">|</span><span class="n">Vice</span> <span class="n">President</span><span class="p">,</span> <span class="n">S</span><span class="o">.</span><span class="o">.</span><span class="o">.</span><span class="o">|</span>  <span class="mi">2</span><span class="o">/</span><span class="mi">17</span><span class="o">/</span><span class="mi">52</span><span class="o">|</span> <span class="mi">8</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">92</span><span class="o">|</span>  <span class="n">Tacoma</span><span class="o">|</span>   <span class="n">WA</span><span class="o">|</span>  <span class="mi">98401</span><span class="o">|</span>    <span class="n">USA</span><span class="o">|</span>        <span class="mi">0</span><span class="o">|</span>
<span class="o">|</span>         <span class="mi">3</span><span class="o">|</span><span class="n">Leverling</span><span class="o">|</span>    <span class="n">Janet</span><span class="o">|</span><span class="n">Sales</span> <span class="n">Representative</span><span class="o">|</span>  <span class="mi">8</span><span class="o">/</span><span class="mi">28</span><span class="o">/</span><span class="mi">63</span><span class="o">|</span> <span class="mi">3</span><span class="o">/</span><span class="mi">30</span><span class="o">/</span><span class="mi">92</span><span class="o">|</span><span class="n">Kirkland</span><span class="o">|</span>   <span class="n">WA</span><span class="o">|</span>  <span class="mi">98033</span><span class="o">|</span>    <span class="n">USA</span><span class="o">|</span>        <span class="mi">2</span><span class="o">|</span>
<span class="o">|</span>         <span class="mi">4</span><span class="o">|</span>  <span class="n">Peacock</span><span class="o">|</span> <span class="n">Margaret</span><span class="o">|</span><span class="n">Sales</span> <span class="n">Representative</span><span class="o">|</span>  <span class="mi">9</span><span class="o">/</span><span class="mi">17</span><span class="o">/</span><span class="mi">37</span><span class="o">|</span>  <span class="mi">5</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="mi">93</span><span class="o">|</span> <span class="n">Redmond</span><span class="o">|</span>   <span class="n">WA</span><span class="o">|</span>  <span class="mi">98052</span><span class="o">|</span>    <span class="n">USA</span><span class="o">|</span>        <span class="mi">2</span><span class="o">|</span>
<span class="o">|</span>         <span class="mi">5</span><span class="o">|</span><span class="n">Dodsworth</span><span class="o">|</span>     <span class="n">Anne</span><span class="o">|</span>       <span class="n">Sales</span> <span class="n">Manager</span><span class="o">|</span>   <span class="mi">3</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="mi">55</span><span class="o">|</span><span class="mi">10</span><span class="o">/</span><span class="mi">15</span><span class="o">/</span><span class="mi">93</span><span class="o">|</span>  <span class="n">London</span><span class="o">|</span> <span class="n">null</span><span class="o">|</span><span class="n">SW1</span> <span class="mi">8</span><span class="n">JR</span><span class="o">|</span>     <span class="n">UK</span><span class="o">|</span>        <span class="mi">2</span><span class="o">|</span>
<span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">5</span> <span class="n">rows</span>
</code></pre></td></tr></table>
</div>
</div><p>查看分析结果</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="o">&gt;&gt;</span><span class="o">&gt;</span> <span class="n">employees</span><span class="o">.</span><span class="n">explain</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="o">==</span> <span class="n">Parsed</span> <span class="n">Logical</span> <span class="n">Plan</span> <span class="o">==</span>
<span class="n">Relation</span><span class="p">[</span><span class="n">EmployeeID</span><span class="c1">#12,LastName#13,FirstName#14,Title#15,BirthDate#16,HireDate#17,City#18,State#19,Zip#20,Country#21,ReportsTo#22] csv</span>

<span class="o">==</span> <span class="n">Analyzed</span> <span class="n">Logical</span> <span class="n">Plan</span> <span class="o">==</span>
<span class="n">EmployeeID</span><span class="p">:</span> <span class="n">string</span><span class="p">,</span> <span class="n">LastName</span><span class="p">:</span> <span class="n">string</span><span class="p">,</span> <span class="n">FirstName</span><span class="p">:</span> <span class="n">string</span><span class="p">,</span> <span class="n">Title</span><span class="p">:</span> <span class="n">string</span><span class="p">,</span> <span class="n">BirthDate</span><span class="p">:</span> <span class="n">string</span><span class="p">,</span> <span class="n">HireDate</span><span class="p">:</span> <span class="n">string</span><span class="p">,</span> <span class="n">City</span><span class="p">:</span> <span class="n">string</span><span class="p">,</span> <span class="n">State</span><span class="p">:</span> <span class="n">string</span><span class="p">,</span> <span class="n">Zip</span><span class="p">:</span> <span class="n">string</span><span class="p">,</span> <span class="n">Country</span><span class="p">:</span> <span class="n">string</span><span class="p">,</span> <span class="n">ReportsTo</span><span class="p">:</span> <span class="n">string</span>
<span class="n">Relation</span><span class="p">[</span><span class="n">EmployeeID</span><span class="c1">#12,LastName#13,FirstName#14,Title#15,BirthDate#16,HireDate#17,City#18,State#19,Zip#20,Country#21,ReportsTo#22] csv</span>

<span class="o">==</span> <span class="n">Optimized</span> <span class="n">Logical</span> <span class="n">Plan</span> <span class="o">==</span>
<span class="n">Relation</span><span class="p">[</span><span class="n">EmployeeID</span><span class="c1">#12,LastName#13,FirstName#14,Title#15,BirthDate#16,HireDate#17,City#18,State#19,Zip#20,Country#21,ReportsTo#22] csv</span>

<span class="o">==</span> <span class="n">Physical</span> <span class="n">Plan</span> <span class="o">==</span>
<span class="o">*</span><span class="n">FileScan</span> <span class="n">csv</span> <span class="p">[</span><span class="n">EmployeeID</span><span class="c1">#12,LastName#13,FirstName#14,Title#15,BirthDate#16,HireDate#17,City#18,State#19,Zip#20,Country#21,ReportsTo#22] Batched: false, Format: CSV, Location: InMemoryFileIndex[file:/Users/linliang/Src/github/fdps-v3/data/NW-Employees.csv], PartitionFilters: [], PushedFilters: [], ReadSchema: struct&lt;EmployeeID:string,LastName:string,FirstName:string,Title:string,BirthDate:string,HireDate:...</span>
</code></pre></td></tr></table>
</div>
</div><p>过滤查询</p>
<pre><code class="language-ptython" data-lang="ptython">&gt;&gt;&gt; result = spark.sql('select * from global_temp.EmployeesTable where State=&quot;WA&quot;')

&gt;&gt;&gt; result.show(5)
+----------+---------+---------+--------------------+---------+--------+--------+-----+-----+-------+---------+
|EmployeeID| LastName|FirstName|               Title|BirthDate|HireDate|    City|State|  Zip|Country|ReportsTo|
+----------+---------+---------+--------------------+---------+--------+--------+-----+-----+-------+---------+
|         1|   Fuller|   Andrew|Sales Representative|  12/6/48| 4/29/92| Seattle|   WA|98122|    USA|        2|
|         2|  Davolio|    Nancy|Vice President, S...|  2/17/52| 8/12/92|  Tacoma|   WA|98401|    USA|        0|
|         3|Leverling|    Janet|Sales Representative|  8/28/63| 3/30/92|Kirkland|   WA|98033|    USA|        2|
|         4|  Peacock| Margaret|Sales Representative|  9/17/37|  5/1/93| Redmond|   WA|98052|    USA|        2|
|         8| Callahan|    Laura|Inside Sales Coor...|   1/7/58|  3/3/94| Seattle|   WA|98105|    USA|        2|
+----------+---------+---------+--------------------+---------+--------+--------+-----+-----+-------+---------+
</code></pre><p>综合上面的所有语句到单个文件</p>
<p><code>single_table.py</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">SQL Demo</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">getOrCreate</span><span class="p">(</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">Running Spark version: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">spark</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>

<span class="n">filePath</span> <span class="o">=</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">.</span><span class="s1">&#39;</span>

<span class="c1"># 读取csv文件</span>
<span class="n">employees</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">header</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">true</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">data/NW-Employees.csv</span><span class="s1">&#39;</span><span class="p">)</span><span class="p">)</span>

<span class="c1"># 统计总行数</span>
<span class="k">print</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">Employees has </span><span class="si">%d</span><span class="s1"> rows</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">employees</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="p">)</span><span class="p">)</span>
<span class="c1"># 打印前5行</span>
<span class="n">employees</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="c1"># 返回前3行</span>
<span class="n">employees</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>


<span class="c1"># 查看每一列的数据类型，默认读取的数据都是String</span>
<span class="k">for</span> <span class="n">column_name</span><span class="p">,</span> <span class="n">data_type</span> <span class="ow">in</span> <span class="n">employees</span><span class="o">.</span><span class="n">dtypes</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">{column_name}: {data_type}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">employees</span><span class="o">.</span><span class="n">printSchema</span><span class="p">(</span><span class="p">)</span>

<span class="c1"># 创建全局的临时视图</span>
<span class="n">employees</span><span class="o">.</span><span class="n">createOrReplaceGlobalTempView</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">EmployeesTable</span><span class="s2">&#34;</span><span class="p">)</span>
<span class="c1"># 查询视图</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">select * from global_temp.EmployeesTable</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">result</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="c1"># 查看分析结果</span>
<span class="n">employees</span><span class="o">.</span><span class="n">explain</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># 添加过滤条件</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">select * from global_temp.EmployeesTable where State=</span><span class="s1">&#34;</span><span class="s1">WA</span><span class="s1">&#34;</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">result</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="n">spark</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="heading2">多表查询</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="o">&gt;&gt;</span><span class="o">&gt;</span> <span class="n">orders</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">header</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">true</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">inferSchema</span><span class="s2">&#34;</span><span class="p">,</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">true</span><span class="s2">&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">data/NW-Orders.csv</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="o">&gt;&gt;</span><span class="o">&gt;</span> <span class="n">order_details</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">header</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">true</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">inferSchema</span><span class="s2">&#34;</span><span class="p">,</span> <span class="sa"></span><span class="s2">&#34;</span><span class="s2">true</span><span class="s2">&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">csv</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">data/NW-Order-Details.csv</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="o">&gt;&gt;</span><span class="o">&gt;</span> <span class="n">orders</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">OrdersTable</span><span class="s2">&#34;</span><span class="p">)</span>

<span class="o">&gt;&gt;</span><span class="o">&gt;</span> <span class="n">order_details</span><span class="o">.</span><span class="n">createOrReplaceTempView</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">OrderDetailsTable</span><span class="s2">&#34;</span><span class="p">)</span>

<span class="o">&gt;&gt;</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;&#39;&#39;</span><span class="s1">
</span><span class="s1"></span><span class="s1">...    SELECT OrderDetailsTable.OrderID, ShipCountry,</span><span class="s1">
</span><span class="s1"></span><span class="s1">...    UnitPrice, Qty, Discount FROM OrdersTable INNER JOIN OrderDetailsTable ON</span><span class="s1">
</span><span class="s1"></span><span class="s1">...    OrdersTable.OrderID = OrderDetailsTable.OrderID</span><span class="s1">
</span><span class="s1"></span><span class="s1">... </span><span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>

<span class="o">&gt;&gt;</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span>
<span class="o">|</span><span class="n">OrderID</span><span class="o">|</span><span class="n">ShipCountry</span><span class="o">|</span><span class="n">UnitPrice</span><span class="o">|</span><span class="n">Qty</span><span class="o">|</span><span class="n">Discount</span><span class="o">|</span>
<span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span>
<span class="o">|</span>  <span class="mi">10248</span><span class="o">|</span>     <span class="n">France</span><span class="o">|</span>     <span class="mf">34.8</span><span class="o">|</span>  <span class="mi">5</span><span class="o">|</span>     <span class="mf">0.0</span><span class="o">|</span>
<span class="o">|</span>  <span class="mi">10248</span><span class="o">|</span>     <span class="n">France</span><span class="o">|</span>      <span class="mf">9.8</span><span class="o">|</span> <span class="mi">10</span><span class="o">|</span>     <span class="mf">0.0</span><span class="o">|</span>
<span class="o">|</span>  <span class="mi">10248</span><span class="o">|</span>     <span class="n">France</span><span class="o">|</span>     <span class="mf">14.0</span><span class="o">|</span> <span class="mi">12</span><span class="o">|</span>     <span class="mf">0.0</span><span class="o">|</span>
<span class="o">|</span>  <span class="mi">10249</span><span class="o">|</span>    <span class="n">Germany</span><span class="o">|</span>     <span class="mf">42.4</span><span class="o">|</span> <span class="mi">40</span><span class="o">|</span>     <span class="mf">0.0</span><span class="o">|</span>
<span class="o">|</span>  <span class="mi">10249</span><span class="o">|</span>    <span class="n">Germany</span><span class="o">|</span>     <span class="mf">18.6</span><span class="o">|</span>  <span class="mi">9</span><span class="o">|</span>     <span class="mf">0.0</span><span class="o">|</span>
<span class="o">|</span>  <span class="mi">10250</span><span class="o">|</span>     <span class="n">Brazil</span><span class="o">|</span>     <span class="mf">16.8</span><span class="o">|</span> <span class="mi">15</span><span class="o">|</span>    <span class="mf">0.15</span><span class="o">|</span>
<span class="o">|</span>  <span class="mi">10250</span><span class="o">|</span>     <span class="n">Brazil</span><span class="o">|</span>     <span class="mf">42.4</span><span class="o">|</span> <span class="mi">35</span><span class="o">|</span>    <span class="mf">0.15</span><span class="o">|</span>
<span class="o">|</span>  <span class="mi">10250</span><span class="o">|</span>     <span class="n">Brazil</span><span class="o">|</span>      <span class="mf">7.7</span><span class="o">|</span> <span class="mi">10</span><span class="o">|</span>     <span class="mf">0.0</span><span class="o">|</span>
<span class="o">|</span>  <span class="mi">10251</span><span class="o">|</span>     <span class="n">France</span><span class="o">|</span>     <span class="mf">16.8</span><span class="o">|</span> <span class="mi">20</span><span class="o">|</span>     <span class="mf">0.0</span><span class="o">|</span>
<span class="o">|</span>  <span class="mi">10251</span><span class="o">|</span>     <span class="n">France</span><span class="o">|</span>     <span class="mf">15.6</span><span class="o">|</span> <span class="mi">15</span><span class="o">|</span>    <span class="mf">0.05</span><span class="o">|</span>
<span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">10</span> <span class="n">rows</span>


<span class="o">&gt;&gt;</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="sa"></span><span class="s1">&#39;&#39;&#39;</span><span class="s1">
</span><span class="s1"></span><span class="s1">...   SELECT ShipCountry, SUM(OrderDetailsTable.UnitPrice *</span><span class="s1">
</span><span class="s1"></span><span class="s1">...    Qty * Discount) AS ProductSales FROM OrdersTable INNER JOIN</span><span class="s1">
</span><span class="s1"></span><span class="s1">...    OrderDetailsTable ON OrdersTable.OrderID = OrderDetailsTable.OrderID GROUP</span><span class="s1">
</span><span class="s1"></span><span class="s1">...    BY ShipCountry</span><span class="s1">
</span><span class="s1"></span><span class="s1">... </span><span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>

<span class="o">&gt;&gt;</span><span class="o">&gt;</span>

<span class="o">&gt;&gt;</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span>
<span class="o">|</span><span class="n">ShipCountry</span><span class="o">|</span>      <span class="n">ProductSales</span><span class="o">|</span>
<span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span>
<span class="o">|</span>     <span class="n">Sweden</span><span class="o">|</span><span class="mf">5028.5599999999995</span><span class="o">|</span>
<span class="o">|</span>    <span class="n">Germany</span><span class="o">|</span>        <span class="mf">14355.9965</span><span class="o">|</span>
<span class="o">|</span>     <span class="n">France</span><span class="o">|</span> <span class="mf">4140.437499999999</span><span class="o">|</span>
<span class="o">|</span>  <span class="n">Argentina</span><span class="o">|</span>               <span class="mf">0.0</span><span class="o">|</span>
<span class="o">|</span>    <span class="n">Belgium</span><span class="o">|</span><span class="mf">1310.1250000000002</span><span class="o">|</span>
<span class="o">|</span>    <span class="n">Finland</span><span class="o">|</span>          <span class="mf">968.3975</span><span class="o">|</span>
<span class="o">|</span>      <span class="n">Italy</span><span class="o">|</span>           <span class="mf">934.995</span><span class="o">|</span>
<span class="o">|</span>     <span class="n">Norway</span><span class="o">|</span>               <span class="mf">0.0</span><span class="o">|</span>
<span class="o">|</span>      <span class="n">Spain</span><span class="o">|</span>           <span class="mf">1448.69</span><span class="o">|</span>
<span class="o">|</span>    <span class="n">Denmark</span><span class="o">|</span>         <span class="mf">2121.2275</span><span class="o">|</span>
<span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">10</span> <span class="n">rows</span>

<span class="c1"># 排序</span>
<span class="o">&gt;&gt;</span><span class="o">&gt;</span> <span class="n">result</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">ProductSales</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span>
<span class="o">|</span><span class="n">ShipCountry</span><span class="o">|</span>      <span class="n">ProductSales</span><span class="o">|</span>
<span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span>
<span class="o">|</span>        <span class="n">USA</span><span class="o">|</span><span class="mf">17982.369499999997</span><span class="o">|</span>
<span class="o">|</span>    <span class="n">Germany</span><span class="o">|</span>        <span class="mf">14355.9965</span><span class="o">|</span>
<span class="o">|</span>    <span class="n">Austria</span><span class="o">|</span><span class="mf">11492.791500000001</span><span class="o">|</span>
<span class="o">|</span>     <span class="n">Brazil</span><span class="o">|</span>         <span class="mf">8029.7585</span><span class="o">|</span>
<span class="o">|</span>    <span class="n">Ireland</span><span class="o">|</span>          <span class="mf">7337.485</span><span class="o">|</span>
<span class="o">|</span>     <span class="n">Canada</span><span class="o">|</span><span class="mf">5137.8099999999995</span><span class="o">|</span>
<span class="o">|</span>     <span class="n">Sweden</span><span class="o">|</span><span class="mf">5028.5599999999995</span><span class="o">|</span>
<span class="o">|</span>     <span class="n">France</span><span class="o">|</span> <span class="mf">4140.437499999999</span><span class="o">|</span>
<span class="o">|</span>  <span class="n">Venezuela</span><span class="o">|</span>          <span class="mf">4004.261</span><span class="o">|</span>
<span class="o">|</span>    <span class="n">Denmark</span><span class="o">|</span>         <span class="mf">2121.2275</span><span class="o">|</span>
<span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">-</span><span class="o">+</span>
<span class="n">only</span> <span class="n">showing</span> <span class="n">top</span> <span class="mi">10</span> <span class="n">rows</span>

</code></pre></td></tr></table>
</div>
</div>
    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">crazygit</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
      2018-01-15
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">赞赏支持</label>
  <div class="qr-code">
    
    
      <label class="qr-code-image" for="reward">
        <img class="image" src="http://images.wiseturtles.com/wechatpay.jpg">
        <span>微信打赏</span>
      </label>
    
  </div>
</div>

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://crazygit.wiseturtles.com/tags/spark/">spark</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/2018/01/16/fast-data-processing-with-spark2-note-three/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">《Fast Data Processing with Spark 2（Third Edition)》读书笔记三</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/2018/01/11/fast-data-processing-with-spark2-note-one/">
            <span class="next-text nav-default">《Fast Data Processing with Spark 2（Third Edition)》读书笔记一</span>
            <span class="prev-text nav-mobile">下一篇</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "crazygit/hugo-blog-comments"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:crazygit@foxmail.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://twitter.com/lianglin999" rel="me noopener" class="iconfont"
      title="twitter"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1264 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M1229.8616 18.043658c0 0-117.852626 63.135335-164.151872 67.344358-105.225559-164.151872-505.082682-92.598492-437.738325 223.078185C278.622548 312.675223 89.216542 47.506814 89.216542 47.506814s-117.852626 189.406006 75.762402 345.139833C127.097743 396.85567 55.544363 371.601535 55.544363 371.601535S26.081207 535.753407 253.368414 615.724832c-21.045112 29.463156-113.643603 8.418045-113.643603 8.418045s25.254134 143.10676 231.496229 180.987961c-143.10676 130.479693-387.230056 92.598492-370.393967 105.225559 206.242095 189.406006 1119.599946 231.496229 1128.01799-643.98042C1179.353331 249.539887 1263.533778 123.269217 1263.533778 123.269217s-130.479693 37.881201-138.897738 33.672179C1225.652577 98.015083 1229.8616 18.043658 1229.8616 18.043658"></path>
</svg>

    </a>
  
    <a href="https://github.com/crazygit" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="https://www.weibo.com/crazygit/profile" rel="me noopener" class="iconfont"
      title="weibo"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M385.714286 733.714286q12-19.428571 6.285714-39.428571t-25.714286-28.571429q-19.428571-8-41.714286-0.571429t-34.285714 26.285714q-12.571429 19.428571-7.428571 39.142857t24.571429 28.857143 42.571429 1.428571 35.714286-27.142857zm53.714286-69.142857q4.571429-7.428571 2-15.142857t-10-10.571429q-8-2.857143-16.285714 2.857143t-12.285714 10.571429q-9.714286 17.714286 7.428571 25.714286 8 2.857143 16.571429 2.857143t12.571429-10.571429zm99.428571 61.142857q-25.714286 58.285714-90.285714 85.714286t-128 6.857143q-61.142857-19.428571-84.285714-72.285714t3.714286-107.142857q26.857143-53.142857 86.571429-79.428571t120.285714-10.857143q63.428571 16.571429 90.571429 68.285714t1.428571 108.857143zm178.285714-91.428571q-5.142857-54.857143-50.857143-97.142857t-119.142857-62.285714-156.857143-12q-127.428571 13.142857-211.142857 80.857143t-75.714286 151.142857q5.142857 54.857143 50.857143 97.142857t119.142857 62.285714 156.857143 12q127.428571-13.142857 211.142857-80.857143t75.714286-151.142857zm176 2.285714q0 38.857143-21.142857 79.714286t-62.285714 78.285714-96.285714 67.142857-129.142857 47.428571-154.571429 17.714286-157.142857-19.142857-137.428571-53.142857-98-86.285714-37.142857-114q0-65.714286 39.714286-140t112.857143-147.428571q96.571429-96.571429 195.142857-134.857143t140.857143 4q37.142857 36.571429 11.428571 119.428571-2.285714 8-0.571429 11.428571t5.714286 4 8.285714 2.857143 7.714286-2l3.428571-1.142857q79.428571-33.714286 140.571429-33.714286t87.428571 34.857143q25.714286 36 0 101.714286-1.142857 7.428571-2.571429 11.428571t2.571429 7.142857 6.857143 4.285714 9.714286 3.428571q32.571429 10.285714 58.857143 26.857143t45.714286 46.571429 19.428571 66.571429zm-42.285714-356.571429q24 26.857143 31.142857 62t-3.714286 67.142857q-4.571429 13.142857-16.857143 19.428571t-25.428571 2.285714q-13.142857-4.571429-19.428571-16.857143t-2.285714-25.428571q11.428571-36-13.714286-63.428571t-61.142857-20q-13.714286 2.857143-25.714286-4.571429t-14.285714-21.142857q-2.857143-13.714286 4.571429-25.428571t21.142857-14.571429q34.285714-7.428571 68 3.142857t57.714286 37.428571zm103.428571-93.142857q49.714286 54.857143 64.285714 127.142857t-7.714286 138q-5.142857 15.428571-19.428571 22.857143t-29.714286 2.285714-22.857143-19.428571-2.857143-29.714286q16-46.857143 5.714286-98.285714t-45.714286-90.285714q-35.428571-39.428571-84.571429-54.571429t-98.857143-4.857143q-16 3.428571-29.714286-5.428571t-17.142857-24.857143 5.428571-29.428571 24.857143-16.857143q70.285714-14.857143 139.428571 6.571429t118.857143 76.857143z"></path>
</svg>

    </a>


<a href="https://crazygit.wiseturtles.com/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2017 -
    2019
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        crazygit
        
      </span></span>

  
  
    <span id="busuanzi_container">
      访客数/访问量：<span id="busuanzi_value_site_uv"></span>/<span id="busuanzi_value_site_pv"></span>
    </span>
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>






<script id="baidu_analytics">
  var _hmt = _hmt || [];
  (function() {
    if (window.location.hostname === 'localhost') return;
    var hm = document.createElement("script"); hm.async = true;
    hm.src = "https://hm.baidu.com/hm.js?2b47f91b8532d1a5e950c8e77142d95c";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
</script>

<script id="baidu_push">
  (function(){
    if (window.location.hostname === 'localhost') return;
    var bp = document.createElement('script'); bp.async = true;
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
      bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
      bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
  })();
</script>



  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  




  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script type="text/javascript">
    AV.initialize("bWUs89CHYswTxwt88Jf71tIF-gzGzoHsz", "IcudhQhVD2eqKqkOTQQ6agUS");
  </script>

  <script>
    function showHitCount(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push($(this).attr("id").trim());
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var hits = item.get('hits');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(hits);
          }
          for (var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if (countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function (results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("hits");
            counter.save(null, {
              success: function (counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('hits'));
              },
              error: function (counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
             
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
             
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("hits", 1);
            newcounter.save(null, {
              success: function (newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('hits'));
              },
              error: function (newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function (error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function () {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        
        addCount(Counter);
      } else if ($('.post-link').length > 1) {
        
        showHitCount(Counter);
      }
    });
  </script>








  <script src="/js/douban.js"></script>


</body>
</html>
